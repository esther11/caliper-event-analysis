<!DOCTYPE html>
<meta charset="utf-8">
<title>Win2017 User Clustering</title>
<style>
    html, body {
        height: 100%;
        margin: 20px;
        padding: 0;
    }

    h1 {
        font-family: Arial, sans-serif;
        font-size: 24px;
        text-align: center;
    }

    .node text {
        visibility: hidden;
    }

    .link {
        fill: none;
        stroke-opacity: 0.6;
        stroke-width: 3px;
    }

    .node--hover circle{
        stroke: #000;
        stroke-width: 2.5px;
        fill: #000;
    }

    .node--hover text {
        visibility: visible;
        font: 12px sans-serif;
        font-weight: 600;
        fill: #000;
    }

    .node--hover path {
        stroke: #000;
        stroke-opacity: 0.8;
    }

    select {
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        margin: 0 auto;
    }

    #tooltip {
        font: 12px sans-serif;
    }

    #tb-stats {
        display: inline-block;
        margin-top: 50px;
        margin-bottom: 250px;
        text-align: left;
    }

    #tb-stats td {
        padding-left: 12px;
    }

</style>

<h1>Winter 2017 Problem Roulette User Clustering</h1>
<svg width="800" height="800"></svg>

<div style="display: inline-block">
    <select id="select-course" onchange="loadJson()"></select>
    <table id="tb-stats"></table>
</div>

<script type="text/javascript">
    course_dropdown = document.getElementById("select-course");
    courseArray = ["mcdb310",
        "phy135",
        "phy140",
        "phy235",
        "phy240",
        "ch130",
        "stat250",
        "eecs314"
    ];
    courseArray.forEach(function (course) {
        opt = document.createElement("option");
        opt.text = course;
        opt.value = course;
        course_dropdown.appendChild(opt);
    })


    tb = document.getElementById("tb-stats");
    varArray = ["Number of Users",
        "Problems Attempted",
        "Solved Problems Percentage",
        "Unsolved Problems Percentage",
        "Skipped Problems Percentage",
        "Skip Rate",
        "Avg. Complete Duration",
        "Avg. Skip Duration",
        "First Complete Accuracy",
        "Avg. Attempt Count Before Problem Solved",
        "Avg. Duration Before Problem Solved"
    ];
    varArray.forEach(function(name){
        tr = document.createElement("tr");
        th = document.createElement("th");
        th.innerHTML = name;
        td = document.createElement("td");
        tb.appendChild(tr);
        tr.appendChild(th);
        tr.appendChild(td);
    });
</script>


<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
    function radialDendrogram(json_f) {

        var svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height"),
            g = svg.append("g").attr("transform", "translate(" + (width / 2 - 10) + "," + (height / 2 - 10) + ")");

        d3.json(json_f, function(error, data) {
            if (error) throw error;

            console.log(data);

            var treeSize = d3.hierarchy(data).height;

            var tree = d3.cluster()
                .size([360, Math.log(treeSize)*120])
                .separation(function(a, b) { return (a.parent == b.parent ? 1 : 2) / a.depth; });

            var color = d3.scaleSequential(d3.interpolateViridis)
                            .domain([treeSize, 0]);

            var root = tree(d3.hierarchy(data));

            var nodes = g.selectAll(".node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", function(d) { return "node" + (d.children ? " node--internal" : " node--leaf"); })
                .attr("transform", function(d) { return "translate(" + project(d.x, d.y) + ")"; })
                .each(function(d) { d.node = this; })
                .on("mouseover", hovered(true))
                .on("mouseout", hovered(false));

            nodes.append("path")
                .attr("class", "link")
                .attr("stroke", function(d) {return color(d.depth);})
                .attr("d", function(d) {
                    if (d.parent) {
                        function offset (coord) {
                            off_x = project(d.x, d.y)[0];
                            off_y = project(d.x, d.y)[1];
                            return (coord[0]-off_x) + " " + (coord[1]-off_y);
                        }
                        return "M 0 0 "
                            + "C" + offset(project(d.x, (d.y + d.parent.y) / 2))
                            + " " + offset(project(d.parent.x, (d.y + d.parent.y) / 2))
                            + " " + offset(project(d.parent.x, d.parent.y));
                    }
                });

            var leaves = nodes.filter(function(d) { return !d.children; });

            leaves.append("circle")
                .attr("r", function(d) { return Math.log(d.data.TotalProblem*20); })
                .attr("fill", function(d) {return color(d.depth);})
                .attr("fill-opacity", 0.8)
                .attr("stroke", function(d) {return color(d.depth);})
                .attr("stroke-width", 2);

            leaves.append("text")
                .attr("dy", ".31em")
                .attr("x", function(d) { return d.x < 180 === !d.children ? 10 : -10; })
                .attr("text-anchor", function(d) { return d.x < 180 === !d.children ? "start" : "end"; })
                .attr("transform", function(d) { return "rotate(" + (d.x < 180 ? d.x - 90 : d.x + 90) + ")"; })
                .attr("fill", function(d) {return color(d.depth);})
                .text(function(d) { return d.data.name; });

            var internals = nodes.filter(function(d) { return d.children; });

            internals.append("circle")
                .attr("r", 3)
                .attr("fill", "#555");

            g.append("text").attr("id", "tooltip");

        });
    }

    function project(x, y) {
        var angle = (x - 90) / 180 * Math.PI, radius = y;
        return [radius * Math.cos(angle), radius * Math.sin(angle)];
    }

    function hovered(hover) {
        return function(d) {
            d3.selectAll(d.descendants()
                .map(function(x) { return x.node; }))
                .classed("node--hover", hover);

            d3.select("#tooltip")
                .style("visibility", hover ? "visible" : "hidden")
                .attr("transform", "translate(" + project(d.x, d.y) + ")")
                .attr("x", d.x < 180 ? -10 : 10)
                .attr("text-anchor", d.x < 180 ? "end" : "start")
                .text( d.children ? numUser(d)+" Users, "+getAvg(d, 'TotalProblem')+" Problem(s) on Avg" : d.data.TotalProblem+" Problem(s)");

            tds = document.getElementById("tb-stats").getElementsByTagName("td");
            tds[0].innerHTML = numUser(d);
            tds[1].innerHTML = getAvg(d, 'TotalProblem', 1);
            tds[2].innerHTML = getAvg(d, 'SolvedPercent', 2);
            tds[3].innerHTML = getAvg(d, 'UnsolvedPercent', 2);
            tds[4].innerHTML = getAvg(d, 'SkippedPercent', 2);
            tds[5].innerHTML = getAvg(d, 'SkipRate', 2);
            tds[6].innerHTML = getAvg(d, 'AvgCompleteDuration', 1);
            tds[7].innerHTML = getAvg(d, 'AvgSkipDuration', 1);
            tds[8].innerHTML = getAvg(d, 'FirstCompleteCorrectPercent', 2);
            tds[9].innerHTML = getAvg(d, 'AvgAttemptUntilCorrect', 1);
            tds[10].innerHTML = getAvg(d, 'AvgDurationUntilCorrect', 1);
        };
    }

    function numUser(d) {
        num = 0;
        d3.selectAll(d.descendants()
            .map(function(d) { return d.node; }))
            .filter(function(d) { return !d.children; })
            .each(function() {
                num += 1;
            });
        return num;
    }

    function getAvg(d, varName, digits) {
        digits = digits || 0;
        tot = 0;
        num = 0;
        d3.selectAll(d.descendants()
            .map(function(d) { return d.node; }))
            .filter(function(d) { return !d.children; })
            .each(function(d) {
                if (d.data[varName] !== -1){
                    tot += d.data[varName];
                    num += 1;
                }
            });
        if (num === 0) { return 'N/A'; }
        return (tot/num).toFixed(digits);
    }

</script>


<script>
    file_name = "d3-dendrogram-"+course_dropdown.value+".json";
    window.onload = radialDendrogram(file_name);
    console.log("Data sourse: "+file_name);

    function loadJson() {
        file_name = "d3-dendrogram-"+course_dropdown.value+".json";
        console.log("Data sourse: "+file_name);
        d3.select("svg").selectAll("*").remove();
        radialDendrogram(file_name);
    }

</script>

